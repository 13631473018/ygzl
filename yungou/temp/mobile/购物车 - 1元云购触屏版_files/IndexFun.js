$(function(){var a=$("#cartBody");var d=$("#divNone");var b=parseInt($("#hidUserID").val());var c=function(){var k=new $CartComm();var j=$("#divTopMoney");var g=$("#divBtmMoney");var h=$("#divPayBox");var w=function(A,z,y,x){$.PageDialog.fail(A,z,y,x)};var l=function(E,y,z,x,G){var A=255;var D=126;if(typeof(x)!="undefined"){A=x}if(typeof(x)!="undefined"){D=G}var F=null;var H='<div class="clearfix m-round u-tipsEject"><div class="u-tips-txt">'+E+'</div><div class="u-Btn"><div class="u-Btn-li"><a href="javascript:;" id="btnMsgCancel" class="z-CloseBtn">取消</a></div><div class="u-Btn-li"><a id="btnMsgOK" href="javascript:;" class="z-DefineBtn">确定</a></div></div></div>';var C=function(){var I=$("#pageDialog");I.find("a.z-DefineBtn").click(function(){if(typeof(y)!="undefined"&&y!=null){y()}B.close()});I.find("a.z-CloseBtn").click(function(){if(typeof(z)!="undefined"&&z!=null){z()}B.cancel()})};var B=new $.PageDialog(H,{W:A,H:D,close:true,autoClose:false,ready:C})};var n=function(y){var x=function(B,C,z){var A=new RegExp(C,"g");return B.replace(A,z)};var y=escape(y);y=x(y,"\\+","%2B");y=x(y,"/","%2F");return y};var r=function(){var x=$("#i_buynext").hasClass("checked")?1:0;location.href="https://m.1yyg.com/passport/login.html?forward="+n("http://m.1yyg.com/mycart/Payment.do?bx="+x)};var o=function(){var x=0;var y=0;$("input:text[name=num]",a).each(function(B){var A=$(this).attr("id");var z=A.replace("txtNum","");var D=parseInt($("#codeState"+z).val());if(D!=1){return false}var C=parseInt($(this).val());if(!isNaN(C)){y++;x+=C}});if(y>0){if(j.length>0){j.children("span").html(x+".00")}h.find("em.orange").html("<span>￥</span>"+x+".00");h.find("em.num").html(y)}else{h.remove()}};var v=null;var p=function(z,x,C,y){if(z!=3||x<=0){return""}var B=C-y;var A="";if(x<B){A="剩余"+x+"人次，最多可参与"+x+"人次"}else{if(y==0){}else{if(y<C){A="您已参与"+y+"人次，最多可参与"+B+"人次"}}}return A};var s=function(){var L=$(this);var E=L.attr("id");var H=E.replace("txtNum","");var x=$("#oldshopNum"+H);var z=parseInt($("#suplus"+H).val());var K=z;var D=parseInt($("#codeType"+H).val());var y=0;var C=0;var A=(D==3)?true:false;if(A){y=parseInt($("#limitBuyNum"+H).val());C=parseInt($("#haveBuyNum"+H).val());var M=y-C;if(z>M){z=M}}var B,J,G=/^[1-9]{1}\d{0,6}$/;var F;var I=function(){B=x.val();J=L.val();if(J!=""&&B!=J){var O=$(window).width();var N=(O)/2-L.offset().left-127;if(G.test(J)){F=parseInt(J);if(F<=z){x.val(J)}else{F=z;if(A){var P=p(D,K,y,C);if(P!=""){w(P,L,-75,N)}}else{w("最多参与"+F+"人次",L,-75,N)}L.val(F);x.val(F)}e(F,L);f(L,H,F);i(L,F,z);o()}else{w("只能输正整数哦",L,-75,N);L.val(B)}}};v=setInterval(I,200)};var e=function(y,B){var A=B.parent().parent().parent();var x=A.find("div.z-Cart-tips");if(y>100){if(x.length==0){var z=$('<div class="z-Cart-tips">已超过100人次，云购存在一定风险，请谨慎参与！</div>');A.prepend(z)}}else{x.remove()}};var u=function(D,y){var x=parseInt($("#suplus"+D).val());var A=parseInt($("#codeType"+D).val());if(A==3){var C=parseInt($("#limitBuyNum"+D).val());var z=parseInt($("#haveBuyNum"+D).val());var B=C-z;if(x>B){x=B}}else{if(y<=0){y=1}}if(y>x){y=x}return y};var q=function(){if(v!=null){clearInterval(v)}var B=$(this);var z=B.attr("id");var y=z.replace("txtNum","");var x=parseInt($("#oldshopNum"+y).val());var A=parseInt(B.val());if(isNaN(B.val())||B.val()==""){A=x}else{if(x==A){return}}B.val(u(y,A))};var f=function(x,z,y){k.updateShopCart(z,y,function(A){if(A.code==0){$("#tip_"+z).html('总共云购：<em class="arial">'+y+'</em>人次/<em class="orange arial">￥'+y+".00</em>")}else{var C=$(window).width();var B=(C)/2-x.offset().left-127;w("操作失败！",x,-75,B)}})};var m=function(z,G){var D=G.attr("id");var F=D.replace("txtNum","");var A=parseInt($("#suplus"+F).val());var B=parseInt($("#codeType"+F).val());if(B==3){var y=parseInt($("#limitBuyNum"+F).val());var C=parseInt($("#haveBuyNum"+F).val());var H=y-C;if(A>H){A=H}}var x=$("#oldshopNum"+F);var E=parseInt(x.val())+z;if(E>0&&E<=A){i(G,E,A);x.val(E);G.val(E);e(E,G);f(G,F,E);o()}};var i=function(y,A,z){var x=y.prev();var B=y.next();if(z==1){x.addClass("z-jiandis");B.addClass("z-jiadis")}else{if(A==1){x.addClass("z-jiandis");B.removeClass("z-jiadis")}else{if(A==z){x.removeClass("z-jiandis");B.addClass("z-jiadis")}else{x.removeClass("z-jiandis");B.removeClass("z-jiadis")}}}};var t=function(){var x=$("li","#cartBody");if(x.length<1){a.parent().remove();d.show()}else{if(x.length<4){j.remove()}}};k.getShopCart(function(D){if(D.code==0){var E=D.listCart;var J=D.listUpdate;var O=D.listOutDate;var F=D.count;var I=D.money;$("#i_buynext").click(function(){if($(this).hasClass("checked")){$(this).removeClass("checked")}else{$(this).addClass("checked")}}).next().click(function(){$(this).prev().trigger("click")}).next().click(function(){var Q='<div class="g-an-dialog">';Q+='<div class="g-an-con">';Q+="<h6>温馨提示</h6>";Q+="<p>热门商品可能会瞬间抢光哦，此处勾选后系统将会自动为您参与最新一云！</p>";Q+='<a href="javascript:;" class="orange-btn">确认</a>';Q+="</div>";Q+="</div>";var S=function(){var T=$("#pageDialog");T.find("a.orange-btn").click(function(){R.close()})};var R=new $.PageDialog(Q,{W:280,H:248,close:true,autoClose:false,ready:S})});if(F>3){j.html('合计金额：<span class="orange arial">'+I+'.00</span> 元 <a href="javascript:;" class="z-Btn-js">结算</a>').show()}h.find("em.orange").html("<span>￥</span>"+I+".00");h.find("em.num").html(F);h.show();var x="";if(E.length>0){for(var L=0;L<E.length;L++){var K=E[L];var y=K.codeQuantity-K.codeSales;var P=K.codeType==3;var C=y;var A=false;var H=0;if(P){H=K.codeLimitBuy-K.myLimitSales;A=H==0?true:false;C=H>y?y:H}x+="<li>";if(K.shopNum>100){x+='<div class="z-Cart-tips">已超过100人次，云购存在一定风险，请谨慎参与！</div>'}x+='<a class="fl u-Cart-img" href="/product/'+K.codeID+'.html">';x+='<img src="http://mskin.1yyg.com/images/loading.gif" src2="http://mimg.1yyg.com/GoodsPic/pic-200-200/'+K.goodsPic+'" border="0" alt=""/>';if(P){x+='<div class="pTitle pPurchase">限购</div>'}x+="</a>";x+='<div class="u-Cart-r">';x+='<p class="z-Cart-tt"><a href="/product/'+K.codeID+'.html" class="gray6">(第'+K.codePeriod+"云)"+K.goodsName+"</a></p>";x+='<ins class="z-promo gray9">剩余<em class="arial">'+y+"</em>人次";if(P){if(A){x+='<br/><em class="gray9">限购'+K.codeLimitBuy+"人次，您已参与"+K.myLimitSales+"人次</em>"}else{x+='<em>&nbsp;/&nbsp;</em><em class="gray9" style="margin: 0;">限购'+K.codeLimitBuy+"人次</em>"}}x+="</ins>";if(C>0){x+='<p id="tip_'+K.codeID+'"  class="gray9">总共云购：<em class="arial">'+K.shopNum+'</em>人次/<em class="orange arial">￥'+K.shopNum+".00</em></p>";x+='<p class="f-Cart-Other">';x+='<a href="javascript:;" class="fr z-del" name="delLink" isover="0" cid="'+K.codeID+'"></a>';x+='<a href="javascript:;" class="fl z-jian'+(K.shopNum==1?" z-jiandis":"")+'">-</a>';x+='<input  id="txtNum'+K.codeID+'" name="num" type="text" maxlength="6" value="'+K.shopNum+'" class="fl z-amount" />';x+='<a href="javascript:;" class="fl z-jia'+(K.shopNum>=C?" z-jiadis":"")+'">+</a>';x+="</p>"}else{x+='<p class="f-Cart-Other">';x+='<a href="javascript:;" class="fr z-del" name="delLink" isover="0" cid="'+K.codeID+'"></a>';x+="</p>"}x+="</div>";if(C>0){x+='<input id="oldshopNum'+K.codeID+'" type="hidden" value="'+K.shopNum+'" />';x+='<input id="suplus'+K.codeID+'" type="hidden" value="'+y+'" />';x+='<input id="limitBuyNum'+K.codeID+'" type="hidden" value="'+K.codeLimitBuy+'" />';x+='<input id="haveBuyNum'+K.codeID+'" type="hidden" value="'+K.myLimitSales+'" />';x+='<input id="codeType'+K.codeID+'" type="hidden" value="'+K.codeType+'" />';x+='<input id="codeState'+K.codeID+'" type="hidden" value="1" />'}x+="</li>"}}if(J.length>0){for(var L=0;L<J.length;L++){var K=J[L];var y=K.codeQuantity-K.codeSales;var P=K.codeType==3;var C=y;var A=false;var H=0;if(P){H=K.codeLimitBuy-K.myLimitSales;A=H==0?true:false;C=H>y?y:H}x+="<li>";if(K.shopNum>100){x+='<div class="z-Cart-tips">已超过100人次，云购存在一定风险，请谨慎参与！</div>'}x+='<a class="fl u-Cart-img" href="/product/'+K.codeID+'.html">';x+='<img src="http://mskin.1yyg.com/images/loading.gif" src2="http://mimg.1yyg.com/GoodsPic/pic-200-200/'+K.goodsPic+'" border="0" alt=""/>';if(P){x+='<div class="pTitle pPurchase">限购</div>'}x+="</a>";x+='<div class="u-Cart-r">';x+='<p class="z-Cart-tt"><a href="/product/'+K.codeID+'.html" class="gray6">(已更新至第'+K.codePeriod+"云)"+K.goodsName+"</a></p>";x+='<ins class="z-promo gray9">剩余<em class="arial">'+y+"</em>人次";if(P){if(A){x+='<br/><em class="gray9">限购'+K.codeLimitBuy+"人次，您已参与"+K.myLimitSales+"人次</em>"}else{x+='<em>&nbsp;/&nbsp;</em><em class="gray9">限购'+K.codeLimitBuy+"人次</em>"}}x+="</ins>";if(C>0){x+='<p id="tip_'+K.codeID+'"  class="gray9">总共云购：<em class="arial">'+K.shopNum+'</em>人次/<em class="orange arial">￥'+K.shopNum+".00</em></p>";x+='<p class="f-Cart-Other">';x+='<a href="javascript:;" class="fr z-del" name="delLink" isover="0" cid="'+K.codeID+'"></a>';x+='<a href="javascript:;" class="fl z-jian'+(K.shopNum==1?" z-jiandis":"")+'">-</a>';x+='<input  id="txtNum'+K.codeID+'" name="num" type="text" maxlength="6" value="'+K.shopNum+'" class="fl z-amount" />';x+='<a href="javascript:;" class="fl z-jia'+(K.shopNum>=C?" z-jiadis":"")+'">+</a>';x+="</p>"}else{x+='<p class="f-Cart-Other">';x+='<a href="javascript:;" class="fr z-del" name="delLink" isover="0" cid="'+K.codeID+'"></a>';x+="</p>"}x+="</div>";if(C>0){x+='<input id="oldshopNum'+K.codeID+'" type="hidden" value="'+K.shopNum+'" />';x+='<input id="suplus'+K.codeID+'" type="hidden" value="'+y+'" />';x+='<input id="limitBuyNum'+K.codeID+'" type="hidden" value="'+K.codeLimitBuy+'" />';x+='<input id="haveBuyNum'+K.codeID+'" type="hidden" value="'+K.myLimitSales+'" />';x+='<input id="codeType'+K.codeID+'" type="hidden" value="'+K.codeType+'" />';x+='<input id="codeState'+K.codeID+'" type="hidden" value="1" />'}x+="</li>"}}x+="</div>";if(O.length>0){for(var L=0;L<O.length;L++){var K=O[L];x+='<li class="m-list-shelves">';x+='<a class="fl u-Cart-img" href="/product/'+K.codeID+'.html">';x+='<img src="http://mskin.1yyg.com/images/loading.gif" src2="http://mimg.1yyg.com/GoodsPic/pic-200-200/'+K.goodsPic+'" border="0" alt=""/>';x+="</a>";x+='<div class="u-Cart-r">';x+='<p class="z-Cart-tt"><a href="/product/.html" class="gray6">'+K.goodsName+"</a></p>";x+='<p class="f-Cart-Other">';x+='<a href="javascript:;" class="fr z-del" name="delLink" isover="1" cid="'+K.codeID+'"></a>';x+="</p>";x+="</div>";x+="</li>"}}var B=$(x);a.html(B);loadImgFun();B.find("a[name='delLink']").bind("click",function(){var R=$(this);var Q=function(){k.delShopCart(S,function(T){if(T.code==0){R.parent().parent().parent().remove();o();t()}else{w("删除失败，请重试["+T.code+"]")}})};var S=R.attr("cid");if(R.attr("isover")=="1"){Q()}else{l("您确定要删除吗？",Q)}});$("input:text[name=num]",a).each(function(Q){var R=$(this);R.bind("focus",s).bind("blur",q);R.prev().bind("click",function(){m(-1,R)});R.next().bind("click",function(){m(1,R)})});var z=function(){if(I==0){w("对不起，购物车中没有商品！");return}var R=$("#i_buynext").hasClass("checked")?1:0;k.getShopCart(function(S){if(S.code==0){E=S.listCart;J=S.listUpdate;O=S.listOutDate;if(E.length==0&&J.length==0){l("您的购物车中所有商品已失效！",function(){$.cookie("_CartData_"+b,null,{domain:"1yyg.com",path:"/",expires:7});$.cookie("_CartDataSel",null,{domain:"1yyg.com",path:"/",expires:1});location.reload()},function(){location.reload()},300)}else{if(O.length>0&&R==0){l("部分商品已失效，继续云购？",function(){if(J.length>0){l("部分商品失效已更新到最新一云，继续云购？",function(){Q()},function(){location.reload()},300)}else{Q()}},function(){location.reload()},300)}else{if(J.length>0&&R==0){l("部分商品失效已更新到最新一云，继续云购？",function(){Q()},function(){location.reload()},300)}else{Q()}}}}});var Q=function(){var V="",Y="";if(E.length>0){for(var T=0;T<E.length;T++){var S=E[T];var U=S.codeQuantity-S.codeSales;var W=U;if(S.codeType==3){var X=S.codeLimitBuy-S.myLimitSales;W=X>U?U:X}if(W>0){V+=E[T].codeID+",";Y+=E[T].shopNum+","}}}if(J.length>0){for(var T=0;T<J.length;T++){var S=J[T];var U=S.codeQuantity-S.codeSales;var W=U;if(S.codeType==3){var X=S.codeLimitBuy-S.myLimitSales;W=X>U?U:X}if(W>0){V+=J[T].codeID+",";Y+=J[T].shopNum+","}}}if(V==""||Y==""){w("对不起，没有购买的商品！");return}V=V.substring(0,V.length-1);Y=Y.substring(0,Y.length-1);k.setSelValue(V,Y,function(){location.href="/mycart/Payment.do?bx="+R})}};h.find("a.w_account").bind("click",function(){z()});j.children("a").bind("click",function(){z()});if($.cookie("_autoBuyTipM")!="1"){$("html, body").scrollTop(10000);var G=$("#i_buynext");var N=G.offset().top-($(window).width()*0.3828125)+28;var M=$('<div><div class="g-auto-nextWrapper"></div><div class="g-auto-nextip" style="top:'+N+'px"></div></div>');M.click(function(){$.cookie("_autoBuyTipM","1",{expires:100});M.remove()});$("section.g-Cart").append(M)}}else{t()}})};if(a.length>0){Base.getScript(Gobal.Skin+"/JS/pageDialog.js?v=130826",function(){Base.getScript(Gobal.Skin+"/JS/CartComm.js?v=160523",c)})}else{d.show()}});